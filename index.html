<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>â¬¡ EagleEye â€” Assembly Tracking</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>â¬¡</text></svg>">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    *{box-sizing:border-box;margin:0;padding:0}html,body,#root{height:100%}
    body{background:#0a0b0f;color:#d1d5e4;font-family:'DM Sans',sans-serif;-webkit-font-smoothing:antialiased}
    ::-webkit-scrollbar{width:4px}::-webkit-scrollbar-track{background:#0a0b0f}::-webkit-scrollbar-thumb{background:#1e2030;border-radius:2px}
    select option{background:#12131a;color:#d1d5e4}
    input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}
    input[type=number]{-moz-appearance:textfield}@keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="config.js"></script>
  <script src="https://unpkg.com/react@18/umd/react.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2" crossorigin></script>
</head>
<body><div id="root"></div>
<script type="text/babel">
const{useState,useEffect,useRef,useMemo,useCallback,createContext,useContext}=React;
const CFG=window.EAGLE_EYE_CONFIG;
if(!CFG||!CFG.SUPABASE_URL||!CFG.SUPABASE_ANON_KEY){document.getElementById('root').innerHTML='<div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;color:#d1d5e4;text-align:center;padding:40px"><div style="font-size:48px;margin-bottom:16px">ğŸ”’</div><div style="font-size:22px;font-weight:700;color:#ef4444">Config Missing</div><div style="font-size:14px;color:#6b7080;margin-top:10px">Copy config.template.js â†’ config.js and fill in your Supabase keys.</div></div>';throw new Error("config missing")}
const supabase=window.supabase.createClient(CFG.SUPABASE_URL,CFG.SUPABASE_ANON_KEY);
const mono="'JetBrains Mono','Fira Code',monospace";
const sans="'DM Sans','Segoe UI',sans-serif";
const T={bg:"#0a0b0f",bgCard:"#12131a",bgHover:"#1a1c24",bgModal:"#15161e",border:"#1e2030",text:"#d1d5e4",textMuted:"#6b7080",textDim:"#3a3d4d",accent:"#f59e0b",headerBg:"#0e0f15"};
const DISP={reuse:{label:"REUSE",color:"#3b82f6",icon:"â™»ï¸",bg:"rgba(59,130,246,0.12)"},scrap:{label:"SCRAP",color:"#ef4444",icon:"ğŸ—‘ï¸",bg:"rgba(239,68,68,0.12)"},rework:{label:"REWORK",color:"#f59e0b",icon:"ğŸ”§",bg:"rgba(245,158,11,0.12)"}};
const inp={background:"#0d0e14",border:"1px solid #1e2030",borderRadius:6,padding:"5px 8px",color:"#d1d5e4",fontSize:11,fontFamily:mono,outline:"none"};
const btnSm=(c,b)=>({padding:"3px 10px",borderRadius:6,fontSize:10,fontWeight:700,border:"1px solid "+(b||"#1e2030"),background:c+"12",color:c,cursor:"pointer",fontFamily:mono});

// AUTH
const AuthContext=createContext(null);
function AuthProvider({children}){
  const[session,setSession]=useState(null);const[role,setRole]=useState(null);const[loading,setLoading]=useState(true);
  useEffect(()=>{
    supabase.auth.getSession().then(({data:{session}})=>{setSession(session);if(session)fetchRole(session.user.email);else setLoading(false)});
    const{data:{subscription}}=supabase.auth.onAuthStateChange((_e,session)=>{setSession(session);if(session)fetchRole(session.user.email);else{setRole(null);setLoading(false)}});
    return()=>subscription.unsubscribe();
  },[]);
  const fetchRole=async(email)=>{const{data}=await supabase.from('authentication_mode_user_roles').select('role').eq('email',email).single();setRole(data?.role||'viewer');setLoading(false)};
  const login=async()=>{await supabase.auth.signInWithOAuth({provider:'google',options:{redirectTo:window.location.origin+window.location.pathname}})};
  const logout=async()=>{await supabase.auth.signOut();setSession(null);setRole(null)};
  return <AuthContext.Provider value={{session,role,loading,login,logout,user:session?.user}}>{children}</AuthContext.Provider>;
}
function useAuth(){return useContext(AuthContext)}

function LoginScreen(){
  const{login}=useAuth();
  return(<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100vh",background:T.bg,padding:40}}>
    <div style={{position:"fixed",inset:0,pointerEvents:"none",background:"radial-gradient(ellipse at 50% 30%, rgba(245,158,11,0.06) 0%, transparent 70%)"}}/>
    <div style={{position:"relative",zIndex:1,textAlign:"center"}}>
      <div style={{width:80,height:80,borderRadius:24,margin:"0 auto 20px",background:"linear-gradient(135deg,#f59e0b,#ef4444)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:42,boxShadow:"0 12px 48px rgba(245,158,11,0.3)"}}>â¬¡</div>
      <div style={{fontSize:32,fontWeight:900,color:T.accent,fontFamily:mono,letterSpacing:-2,marginBottom:6}}>EagleEye</div>
      <div style={{fontSize:14,color:T.textMuted,marginBottom:40}}>Assembly version tracking & ECN management</div>
      <button onClick={login} style={{display:"flex",alignItems:"center",gap:12,padding:"14px 32px",borderRadius:12,border:"1px solid "+T.border,background:T.bgCard,color:T.text,fontSize:15,fontWeight:600,cursor:"pointer",margin:"0 auto"}}>
        <svg width="20" height="20" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"/><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"/><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"/></svg>
        Sign in with Google</button>
      <div style={{fontSize:11,color:T.textDim,marginTop:24,maxWidth:300,lineHeight:1.6,margin:"24px auto 0"}}>Access controlled by your organization admin.</div>
    </div></div>);
}

// DATA LAYER
const DB={
  async getAssemblies(){const{data}=await supabase.from('eagle_eye_app_assemblies').select('*').order('code');return data||[]},
  async getUnits(aId){const{data}=await supabase.from('eagle_eye_app_production_units').select('*').eq('assembly_id',aId).order('sn');return data||[]},
  async getVersions(aId){const{data}=await supabase.from('eagle_eye_app_version_history').select('*').eq('assembly_id',aId).order('version');return data||[]},
  async getActiveVersion(aId){const{data}=await supabase.from('eagle_eye_app_version_history').select('*').eq('assembly_id',aId).eq('status','active').single();return data},
  async getTree(vId){
    const{data:groups}=await supabase.from('eagle_eye_app_groups').select('*').eq('version_id',vId).order('sequence');
    if(!groups)return[];
    const{data:steps}=await supabase.from('eagle_eye_app_steps').select('*').eq('version_id',vId).order('sequence');
    const sids=(steps||[]).map(s=>s.id);
    const{data:links}=sids.length?await supabase.from('eagle_eye_app_step_links').select('*,master_parts_list_all(part_number,name)').in('step_id',sids):{data:[]};
    const{data:fasts}=sids.length?await supabase.from('eagle_eye_app_fasteners').select('*').in('step_id',sids):{data:[]};
    return groups.map(g=>({...g,steps:(steps||[]).filter(s=>s.group_id===g.id).map(s=>({...s,
      parts:(links||[]).filter(l=>l.step_id===s.id).map(l=>({id:l.id,pn:l.master_parts_list_all?.part_number||'',name:l.master_parts_list_all?.name||'',qty:l.quantity})),
      fasteners:(fasts||[]).filter(f=>f.step_id===s.id).map(f=>({id:f.id,code:f.code||'',torque:f.torque_nm?f.torque_nm+'Nm':'',loctite:f.loctite_type||'',qty:f.quantity})),
    }))}))}
  },
  async getECNChanges(aId){const{data}=await supabase.from('eagle_eye_app_ecn_change_records').select('*').eq('assembly_id',aId).order('seq_tag');return data||[]},
  async getApplied(sn){const{data}=await supabase.from('eagle_eye_app_ecn_applications').select('*').eq('unit_sn',sn);return new Set((data||[]).map(d=>d.unit_sn+'-'+d.seq_tag))},
  async applyECN(sn,tag,sid,email){const{error}=await supabase.from('eagle_eye_app_ecn_applications').upsert({unit_sn:sn,seq_tag:tag,step_id:sid,applied:true,applied_by:email,applied_at:new Date().toISOString()},{onConflict:'unit_sn,seq_tag'});return!error},
  async unapplyECN(sn,tag){const{error}=await supabase.from('eagle_eye_app_ecn_applications').delete().eq('unit_sn',sn).eq('seq_tag',tag);return!error},
  async upgradeUnit(sn,ver){const{error}=await supabase.from('eagle_eye_app_production_units').update({version:ver,status:'current',updated_at:new Date().toISOString()}).eq('sn',sn);return!error},
  async searchParts(q){if(!q||q.length<2)return[];const{data}=await supabase.from('master_parts_list_all').select('part_number,name').or('part_number.ilike.%'+q+'%,name.ilike.%'+q+'%').limit(10);return data||[]},
  // Write ops
  async updateStep(id,fields){return!(await supabase.from('eagle_eye_app_steps').update(fields).eq('id',id)).error},
  async addStep(vId,gId,seq){const{data}=await supabase.from('eagle_eye_app_steps').insert({version_id:vId,group_id:gId,step_number:'',step_type:'STEP',name:'',sequence:seq}).select().single();return data},
  async deleteStep(id){await supabase.from('eagle_eye_app_step_links').delete().eq('step_id',id);await supabase.from('eagle_eye_app_fasteners').delete().eq('step_id',id);return!(await supabase.from('eagle_eye_app_steps').delete().eq('id',id)).error},
  async addGroup(vId,seq){const{data}=await supabase.from('eagle_eye_app_groups').insert({version_id:vId,name:'New Group',icon:'ğŸ“¦',color:'#6366f1',level:null,sequence:seq}).select().single();return data},
  async updateGroup(id,fields){return!(await supabase.from('eagle_eye_app_groups').update(fields).eq('id',id)).error},
  async addStepPart(sId,pn,name,qty){const{data:m}=await supabase.from('master_parts_list_all').select('id').eq('part_number',pn).single();const{data}=await supabase.from('eagle_eye_app_step_links').insert({step_id:sId,part_id:m?.id||null,quantity:qty||1}).select().single();return data},
  async removeStepPart(id){return!(await supabase.from('eagle_eye_app_step_links').delete().eq('id',id)).error},
  async addFastener(sId){const{data}=await supabase.from('eagle_eye_app_fasteners').insert({step_id:sId,code:'',torque_nm:null,loctite_type:'',quantity:1}).select().single();return data},
  async removeFastener(id){return!(await supabase.from('eagle_eye_app_fasteners').delete().eq('id',id)).error},
  async updateFastener(id,fields){return!(await supabase.from('eagle_eye_app_fasteners').update(fields).eq('id',id)).error},
  async updateVersion(id,fields){return!(await supabase.from('eagle_eye_app_version_history').update(fields).eq('id',id)).error},
  async cloneVersion(asmId,fromVerId,newVer,notes){
    const{data:nv,error}=await supabase.from('eagle_eye_app_version_history').insert({assembly_id:asmId,version:newVer,status:'active',notes:notes||'',created_by:'admin',created_at:new Date().toISOString()}).select().single();
    if(error||!nv)return null;
    await supabase.from('eagle_eye_app_version_history').update({status:'frozen'}).eq('id',fromVerId);
    const{data:og}=await supabase.from('eagle_eye_app_groups').select('*').eq('version_id',fromVerId).order('sequence');
    if(!og?.length)return nv;
    const gm={};for(const g of og){const{data:ng}=await supabase.from('eagle_eye_app_groups').insert({version_id:nv.id,name:g.name,icon:g.icon,color:g.color,level:g.level,sequence:g.sequence}).select().single();if(ng)gm[g.id]=ng.id}
    const{data:os}=await supabase.from('eagle_eye_app_steps').select('*').eq('version_id',fromVerId).order('sequence');
    const sm={};for(const s of(os||[])){const{data:ns}=await supabase.from('eagle_eye_app_steps').insert({version_id:nv.id,group_id:gm[s.group_id],step_number:s.step_number,step_type:s.step_type,name:s.name,sequence:s.sequence}).select().single();if(ns)sm[s.id]=ns.id}
    const oids=Object.keys(sm);
    if(oids.length){const{data:ol}=await supabase.from('eagle_eye_app_step_links').select('*').in('step_id',oids);for(const l of(ol||[]))await supabase.from('eagle_eye_app_step_links').insert({step_id:sm[l.step_id],part_id:l.part_id,quantity:l.quantity})}
    if(oids.length){const{data:of2}=await supabase.from('eagle_eye_app_fasteners').select('*').in('step_id',oids);for(const f of(of2||[]))await supabase.from('eagle_eye_app_fasteners').insert({step_id:sm[f.step_id],code:f.code,torque_nm:f.torque_nm,loctite_type:f.loctite_type,quantity:f.quantity})}
    await supabase.from('eagle_eye_app_production_units').update({status:'outdated',latest_version:newVer}).eq('assembly_id',asmId);
    return nv;
  },
  async log(a,t,r,d){const{data:{user}}=await supabase.auth.getUser();await supabase.from('authentication_mode_audit_log').insert({user_email:user?.email,action:a,table_name:t,record_id:String(r),details:d})},
};

// CASCADE
function chainOf(sn){const m=(sn||'').match(/^(\d+)/);return m?m[1]:sn}
function computeCascade(tree,changes,applied,unitSn){
  const flat=[];tree.forEach(g=>(g.steps||[]).forEach(s=>flat.push({sn:s.step_number||s.sn,chain:chainOf(s.step_number||s.sn)})));
  const ecnSet=new Set(changes.map(c=>c.step||c.seq_tag));const r=new Map();
  changes.forEach(ch=>{const tag=ch.step||ch.seq_tag,cc=chainOf(tag);if(applied.has(unitSn+'-'+tag))return;const ci=flat.findIndex(s=>s.sn===tag);if(ci===-1)return;for(let i=ci+1;i<flat.length;i++){if(flat[i].chain!==cc)continue;const e=r.get(flat[i].sn)||{isCascade:false,from:[],isBlocked:false};e.isCascade=true;if(!e.from.includes(tag))e.from.push(tag);r.set(flat[i].sn,e)}});
  changes.forEach(ch=>{const tag=ch.step||ch.seq_tag,cc=chainOf(tag),ci=flat.findIndex(s=>s.sn===tag);for(let i=0;i<ci;i++){if(flat[i].chain!==cc)continue;if(ecnSet.has(flat[i].sn)&&!applied.has(unitSn+'-'+flat[i].sn)){const e=r.get(tag)||{isCascade:false,from:[],isBlocked:false};e.isBlocked=true;if(!e.from.includes(flat[i].sn))e.from.push(flat[i].sn);r.set(tag,e)}}});
  return r;
}

// TOP BAR
function TopBar({onHome}){
  const{user,role,logout}=useAuth();const rc={admin:"#f59e0b",operator:"#3b82f6",viewer:"#6b7080"};const rl={admin:"ğŸ”§ Admin",operator:"ğŸ”¨ Operator",viewer:"ğŸ‘ Viewer"};
  return(<div style={{display:"flex",alignItems:"center",gap:10,padding:"6px 16px",borderBottom:"1px solid "+T.border,background:T.headerBg,position:"sticky",top:0,zIndex:50}}>
    <div onClick={onHome} style={{fontSize:16,fontWeight:800,color:T.accent,fontFamily:mono,cursor:"pointer",display:"flex",alignItems:"center",gap:6}}>â¬¡ <span style={{fontSize:13}}>EagleEye</span></div>
    <div style={{flex:1}}/>
    <span style={{fontSize:9,fontWeight:700,padding:"2px 8px",borderRadius:5,background:(rc[role]||"#6b7080")+"15",color:rc[role]||"#6b7080",fontFamily:mono}}>{rl[role]||role}</span>
    <span style={{fontSize:10,color:T.textMuted,maxWidth:160,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{user?.user_metadata?.full_name||user?.email}</span>
    <button onClick={logout} style={{background:"none",border:"1px solid "+T.border,borderRadius:6,padding:"3px 10px",color:T.textMuted,cursor:"pointer",fontSize:9}}>Logout</button>
  </div>);
}

// HOME PAGE
function HomePage({onNav}){
  const{role}=useAuth();const[assemblies,setAssemblies]=useState([]);const[loading,setLoading]=useState(true);
  useEffect(()=>{DB.getAssemblies().then(d=>{setAssemblies(d);setLoading(false)})},[]);
  return(<div style={{minHeight:"100vh",background:T.bg,display:"flex",flexDirection:"column",alignItems:"center"}}>
    <div style={{textAlign:"center",paddingTop:80,marginBottom:48}}>
      <div style={{fontSize:56,fontWeight:900,color:T.accent,fontFamily:mono,letterSpacing:-3,lineHeight:1}}>â¬¡ EagleEye</div>
      <div style={{fontSize:15,color:T.textMuted,marginTop:10}}>Assembly version tracking & ECN management</div>
      {!loading&&<div style={{display:"flex",gap:16,justifyContent:"center",marginTop:20}}>
        <span style={{fontSize:12,color:T.textMuted,fontFamily:mono}}><span style={{color:T.accent,fontWeight:700}}>{assemblies.length}</span> assemblies</span>
      </div>}
    </div>
    <div style={{display:"flex",gap:16,marginBottom:48,flexWrap:"wrap",justifyContent:"center",padding:"0 24px"}}>
      <div onClick={()=>onNav("units")} style={{width:280,padding:"28px 24px",borderRadius:16,background:T.bgCard,border:"2px solid "+T.accent+"40",cursor:"pointer",transition:"all 0.2s"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor=T.accent;e.currentTarget.style.transform="translateY(-4px)"}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor=T.accent+"40";e.currentTarget.style.transform="none"}}>
        <div style={{fontSize:36,marginBottom:12}}>ğŸ”¨</div>
        <div style={{fontSize:18,fontWeight:700,color:T.accent}}>Unit Tracking</div>
        <div style={{fontSize:12,color:T.textMuted,marginTop:6,lineHeight:1.5}}>Check & apply ECN updates per unit</div>
      </div>
      {role==="admin"&&<div onClick={()=>onNav("editor")} style={{width:280,padding:"28px 24px",borderRadius:16,background:T.bgCard,border:"2px solid #8b5cf640",cursor:"pointer",transition:"all 0.2s"}}
        onMouseEnter={e=>{e.currentTarget.style.borderColor="#8b5cf6";e.currentTarget.style.transform="translateY(-4px)"}}
        onMouseLeave={e=>{e.currentTarget.style.borderColor="#8b5cf640";e.currentTarget.style.transform="none"}}>
        <div style={{fontSize:36,marginBottom:12}}>ğŸ”§</div>
        <div style={{fontSize:18,fontWeight:700,color:"#8b5cf6"}}>Tree Editor</div>
        <div style={{fontSize:12,color:T.textMuted,marginTop:6,lineHeight:1.5}}>Manage versions & assembly trees. Freeze, duplicate, edit inline.</div>
        <div style={{marginTop:14}}><span style={btnSm("#8b5cf6")}>Admin only</span></div>
      </div>}
    </div>
    <div style={{fontSize:12,fontWeight:700,color:T.textMuted,textTransform:"uppercase",letterSpacing:1.5,marginBottom:14,fontFamily:mono}}>Assemblies</div>
    {loading?<div style={{color:T.textMuted,padding:40}}>Loading...</div>:
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(190px,1fr))",gap:10,maxWidth:860,width:"100%",padding:"0 24px 60px"}}>
      {assemblies.map(a=><div key={a.id} onClick={()=>onNav("units",a)} style={{background:T.bgCard,border:"1px solid "+T.border,borderRadius:12,padding:"16px 18px",cursor:"pointer",borderLeft:"3px solid "+T.accent,transition:"all 0.15s"}}
        onMouseEnter={e=>e.currentTarget.style.transform="translateY(-2px)"} onMouseLeave={e=>e.currentTarget.style.transform="none"}>
        <div style={{fontSize:14,fontWeight:700,marginBottom:4}}>{a.name||a.code}</div>
        <div style={{fontSize:10,color:T.textMuted}}>{a.description||a.code}</div>
        <div style={{marginTop:8}}><span style={{fontSize:9,fontWeight:700,padding:"2px 7px",borderRadius:6,background:T.accent+"12",color:T.accent,fontFamily:mono}}>{a.code}</span></div>
      </div>)}
    </div>}
  </div>);
}

// UNIT SELECT
function UnitSelectPage({assembly,onBack,onProceed}){
  const[units,setUnits]=useState([]);const[loading,setLoading]=useState(true);const[sel,setSel]=useState(new Set());const[filter,setFilter]=useState("all");const[search,setSearch]=useState("");
  useEffect(()=>{DB.getUnits(assembly.id).then(d=>{setUnits(d);setLoading(false)})},[assembly.id]);
  const filtered=units.filter(u=>{if(filter==="outdated"&&u.status!=="outdated")return false;if(filter==="current"&&u.status!=="current")return false;if(search&&!u.sn.toLowerCase().includes(search.toLowerCase()))return false;return true});
  const toggle=sn=>{const n=new Set(sel);n.has(sn)?n.delete(sn):n.add(sn);setSel(n)};const outCount=units.filter(u=>u.status==="outdated").length;
  return(<div style={{padding:"20px 24px",maxWidth:900,margin:"0 auto"}}>
    <div style={{display:"flex",alignItems:"center",gap:12,marginBottom:16}}>
      <button onClick={onBack} style={{background:"none",border:"1px solid "+T.border,borderRadius:7,padding:"5px 12px",color:T.textMuted,cursor:"pointer",fontSize:11}}>â† Back</button>
      <div><div style={{fontSize:18,fontWeight:700}}>{assembly.name||assembly.code}</div>
        <div style={{fontSize:10,color:T.textMuted,fontFamily:mono}}>{units.length} total Â· <span style={{color:"#ef4444",fontWeight:700}}>{outCount} need updates</span></div></div>
    </div>
    <div style={{display:"flex",gap:8,marginBottom:10,flexWrap:"wrap",alignItems:"center"}}>
      <input value={search} onChange={e=>setSearch(e.target.value)} placeholder="Search S/N..." style={{...inp,width:160}}/>
      {["all","outdated","current"].map(f=><button key={f} onClick={()=>setFilter(f)} style={{padding:"4px 10px",borderRadius:7,fontSize:10,fontWeight:600,cursor:"pointer",border:filter===f?"none":"1px solid "+T.border,background:filter===f?(f==="outdated"?"rgba(239,68,68,0.15)":f==="current"?"rgba(34,197,94,0.15)":T.accent+"20"):"transparent",color:filter===f?(f==="outdated"?"#ef4444":f==="current"?"#22c55e":T.accent):T.textMuted,textTransform:"capitalize"}}>{f}</button>)}
      <button onClick={()=>{const n=new Set(sel);filtered.forEach(u=>n.add(u.sn));setSel(n)}} style={{...btnSm(T.textMuted),marginLeft:"auto"}}>Select all ({filtered.length})</button>
    </div>
    {loading?<div style={{textAlign:"center",color:T.textMuted,padding:40}}>Loading...</div>:
    <div style={{display:"grid",gridTemplateColumns:"repeat(auto-fill,minmax(135px,1fr))",gap:4,maxHeight:420,overflowY:"auto",padding:2}}>
      {filtered.map(u=>{const s=sel.has(u.sn),out=u.status==="outdated";return(
        <div key={u.sn} onClick={()=>toggle(u.sn)} style={{padding:"7px 9px",borderRadius:7,cursor:"pointer",border:s?"2px solid "+T.accent:"1px solid "+T.border,background:s?T.accent+"06":T.bgCard,position:"relative"}}>
          {s&&<div style={{position:"absolute",top:4,right:6,fontSize:11,color:T.accent}}>âœ“</div>}
          <div style={{fontSize:11,fontWeight:700,fontFamily:mono}}>{u.sn}</div>
          <div style={{display:"flex",gap:3,marginTop:2}}>
            <span style={{fontSize:8,fontWeight:700,padding:"1px 4px",borderRadius:4,background:out?"rgba(239,68,68,0.1)":"rgba(34,197,94,0.1)",color:out?"#ef4444":"#22c55e",fontFamily:mono}}>v{u.version}</span>
            {out&&<span style={{fontSize:7,color:"#ef4444"}}>â†’ v{u.latest_version}</span>}
          </div></div>)})}
    </div>}
    {sel.size>0&&<div style={{marginTop:12,padding:"9px 14px",borderRadius:10,background:T.accent+"06",border:"1px solid "+T.accent+"20",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
      <span style={{fontWeight:700,fontSize:12}}>{sel.size} selected</span>
      <button onClick={()=>onProceed([...sel].map(sn=>units.find(u=>u.sn===sn)).filter(Boolean))} style={{padding:"7px 20px",borderRadius:9,fontSize:12,fontWeight:700,background:T.accent,border:"none",color:"#000",cursor:"pointer"}}>Open Assembly View â†’</button>
    </div>}
  </div>);
}

// ASSEMBLY VIEW
function AssemblyViewPage({assembly,selectedUnits,onBack}){
  const{role,user}=useAuth();const[tab,setTab]=useState("list");const[unit,setUnit]=useState(selectedUnits[0]);
  const[tree,setTree]=useState([]);const[changes,setChanges]=useState([]);const[applied,setApplied]=useState(new Set());
  const[expanded,setExpanded]=useState(new Set());const[loading,setLoading]=useState(true);
  useEffect(()=>{(async()=>{setLoading(true);const ver=await DB.getActiveVersion(assembly.id);if(ver){const t=await DB.getTree(ver.id);setTree(t);setExpanded(new Set(t.map(g=>g.id)))}const ch=await DB.getECNChanges(assembly.id);setChanges(ch);const ap=await DB.getApplied(unit.sn);setApplied(ap);setLoading(false)})()},[unit.sn,assembly.id]);
  const isOut=unit.status==="outdated";const ecnSet=new Set(changes.map(c=>c.seq_tag||c.step));
  const cascade=computeCascade(tree,changes,applied,unit.sn);
  const allDone=changes.length>0&&changes.every(c=>applied.has(unit.sn+'-'+(c.seq_tag||c.step)));
  const appliedCount=[...applied].filter(k=>k.startsWith(unit.sn)).length;const canWrite=role==="admin"||role==="operator";
  const togApply=async ch=>{const tag=ch.seq_tag||ch.step,key=unit.sn+'-'+tag;if(applied.has(key)){if(await DB.unapplyECN(unit.sn,tag)){const n=new Set(applied);n.delete(key);setApplied(n)}}else{if(await DB.applyECN(unit.sn,tag,ch.step_id,user?.email)){const n=new Set(applied);n.add(key);setApplied(n)}}};
  const handleUpgrade=async()=>{if(await DB.upgradeUnit(unit.sn,unit.latest_version))setUnit({...unit,version:unit.latest_version,status:"current"})};
  if(loading)return<div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"60vh",color:T.textMuted}}>Loading...</div>;
  return(<div style={{minHeight:"calc(100vh - 36px)",background:T.bg}}>
    <div style={{display:"flex",alignItems:"center",gap:8,padding:"7px 16px",borderBottom:"1px solid "+T.border,background:T.headerBg,flexWrap:"wrap"}}>
      <button onClick={onBack} style={{background:"none",border:"1px solid "+T.border,borderRadius:6,padding:"3px 10px",color:T.textMuted,cursor:"pointer",fontSize:10}}>â† Units</button>
      <select value={unit.sn} onChange={e=>setUnit(selectedUnits.find(u=>u.sn===e.target.value))} style={{...inp,padding:"4px 8px",fontWeight:600}}>
        {selectedUnits.map(u=><option key={u.sn} value={u.sn}>{u.sn} â€” v{u.version} {u.status==="outdated"?"âš ":"âœ“"}</option>)}</select>
      <div style={{display:"flex",alignItems:"center",gap:4,padding:"2px 8px",background:isOut?"rgba(239,68,68,0.08)":"rgba(34,197,94,0.08)",border:"1px solid "+(isOut?"rgba(239,68,68,0.2)":"rgba(34,197,94,0.2)"),borderRadius:12,fontSize:10,fontWeight:700,color:isOut?"#ef4444":"#22c55e",fontFamily:mono}}>
        v{unit.version}{isOut&&<span style={{fontWeight:400,opacity:0.7}}> â†’ v{unit.latest_version}</span>}</div>
    </div>
    <div style={{display:"flex",padding:"0 16px",borderBottom:"1px solid "+T.border,background:T.headerBg}}>
      {[{id:"list",label:"List View",icon:"â˜°"},{id:"graph",label:"Graph",icon:"â—ˆ"},{id:"kanban",label:"Kanban",icon:"â–¦"}].map(t=>{const a=tab===t.id;return<button key={t.id} onClick={()=>setTab(t.id)} style={{display:"flex",alignItems:"center",gap:4,padding:"8px 14px",fontSize:11,fontWeight:a?700:500,color:a?T.accent:T.textMuted,background:"transparent",border:"none",cursor:"pointer",borderBottom:a?"2px solid "+T.accent:"2px solid transparent"}}><span style={{fontSize:12,opacity:a?1:0.5}}>{t.icon}</span> {t.label}
        {t.id==="list"&&changes.length-appliedCount>0&&<span style={{fontSize:8,fontWeight:700,padding:"1px 5px",borderRadius:5,background:"rgba(239,68,68,0.12)",color:"#ef4444",fontFamily:mono}}>{changes.length-appliedCount}</span>}
        {(t.id==="graph"||t.id==="kanban")&&<span style={{fontSize:7,padding:"1px 4px",borderRadius:3,background:T.textDim+"18",color:T.textDim,fontFamily:mono}}>SOON</span>}
      </button>})}
    </div>
    {tab==="list"&&<>
      {isOut&&changes.length>0&&<div style={{margin:"8px 16px 0",padding:"9px 12px",borderRadius:9,background:"rgba(239,68,68,0.03)",border:"1px solid rgba(239,68,68,0.08)"}}>
        <div style={{display:"flex",justifyContent:"space-between",marginBottom:5}}><span style={{fontSize:11,fontWeight:700,color:"#ef4444"}}>âš  {changes.length} ECN changes</span><span style={{fontSize:9,color:T.textMuted,fontFamily:mono}}>{appliedCount}/{changes.length}</span></div>
        <div style={{height:2,borderRadius:1,background:"rgba(239,68,68,0.08)",overflow:"hidden"}}><div style={{height:"100%",width:changes.length?(appliedCount/changes.length*100)+"%":"0%",background:allDone?"#22c55e":"#f59e0b",transition:"width 0.3s"}}/></div>
        <div style={{marginTop:6,display:"flex",flexDirection:"column",gap:2}}>
          {changes.map((c,i)=>{const tag=c.seq_tag||c.step,done=applied.has(unit.sn+'-'+tag),info=cascade.get(tag),blocked=info?.isBlocked&&!done;
            return<div key={i} onClick={()=>!blocked&&canWrite&&togApply(c)} style={{display:"flex",alignItems:"center",gap:6,padding:"5px 8px",borderRadius:5,background:done?"rgba(34,197,94,0.04)":T.bgCard,border:"1px solid "+(done?"rgba(34,197,94,0.1)":T.border),cursor:blocked?"not-allowed":canWrite?"pointer":"default",opacity:blocked?0.5:1}}>
              <span style={{fontSize:9,fontWeight:700,color:done?"#22c55e":"#ef4444",fontFamily:mono,minWidth:24,textAlign:"center",background:done?"rgba(34,197,94,0.1)":"rgba(239,68,68,0.08)",padding:"1px 4px",borderRadius:3}}>{tag}</span>
              <span style={{flex:1,fontSize:10,fontWeight:500,opacity:done?0.5:1,textDecoration:done?"line-through":"none"}}>{c.step_name||c.field||"Change"}</span>
              {blocked&&<span style={{fontSize:9}}>ğŸ”’</span>}<span style={{fontSize:11,color:done?"#22c55e":T.textDim}}>{done?"âœ“":"â—‹"}</span>
            </div>})}
        </div>
        {allDone&&<div style={{marginTop:8,padding:"10px 12px",borderRadius:8,background:"rgba(34,197,94,0.05)",border:"1px solid rgba(34,197,94,0.2)",display:"flex",alignItems:"center",justifyContent:"space-between"}}>
          <div style={{fontSize:12,fontWeight:700,color:"#22c55e"}}>âœ… All changes applied</div>
          {canWrite&&<button onClick={handleUpgrade} style={{padding:"6px 18px",borderRadius:8,fontSize:11,fontWeight:700,background:"#22c55e",border:"none",color:"#000",cursor:"pointer"}}>âœ“ Upgrade to v{unit.latest_version}</button>}
        </div>}
      </div>}
      <div style={{padding:"8px 16px 40px",maxWidth:960,margin:"0 auto"}}>
        {tree.map(group=>{const open=expanded.has(group.id);return<div key={group.id} style={{marginBottom:1}}>
          <div onClick={()=>{const n=new Set(expanded);n.has(group.id)?n.delete(group.id):n.add(group.id);setExpanded(n)}} style={{display:"flex",alignItems:"center",gap:6,padding:"7px 12px",background:T.bgCard,borderLeft:"3px solid "+(group.color||T.accent),cursor:"pointer"}}>
            <span style={{color:T.textMuted,fontSize:9,transform:open?"rotate(90deg)":"rotate(0)",transition:"0.15s"}}>â–¶</span>
            <span style={{fontSize:13}}>{group.icon||"ğŸ“¦"}</span>
            <span style={{color:group.color||T.accent,fontWeight:700,fontSize:12,flex:1}}>{group.name}</span>
            {group.level!=null&&<span style={{fontSize:8,fontWeight:700,padding:"1px 5px",borderRadius:4,background:(group.color||T.accent)+"15",color:group.color||T.accent,fontFamily:mono}}>L{group.level}</span>}
            <span style={{fontSize:9,color:T.textMuted,fontFamily:mono}}>{(group.steps||[]).length}</span>
          </div>
          {open&&(group.steps||[]).map(step=>{const sn=step.step_number,isEcn=ecnSet.has(sn),ecnDone=isEcn&&applied.has(unit.sn+'-'+sn),info=cascade.get(sn),isCasc=info?.isCascade&&!ecnDone;
            let lbc=(group.color||T.accent)+"22";if(ecnDone)lbc="#22c55e";else if(isEcn)lbc="#ef4444";else if(isCasc)lbc="#f59e0b";
            return<div key={step.id} style={{display:"flex",alignItems:"center",gap:7,padding:"5px 10px 5px 36px",borderLeft:"3px solid "+lbc,marginLeft:12}}>
              <span style={{fontFamily:mono,fontSize:9,fontWeight:700,color:ecnDone?"#22c55e":isEcn?"#ef4444":isCasc?"#f59e0b":(group.color||T.accent),minWidth:26,textAlign:"center",background:(ecnDone?"#22c55e":isEcn?"#ef4444":(group.color||T.accent))+"12",padding:"1px 4px",borderRadius:3}}>{sn}</span>
              <span style={{fontSize:8,fontWeight:600,padding:"1px 4px",borderRadius:3,background:step.step_type==="PREP"?"rgba(168,85,247,0.12)":"rgba(59,130,246,0.06)",color:step.step_type==="PREP"?"#a855f7":"#3b82f6",fontFamily:mono}}>{step.step_type||"STEP"}</span>
              <div style={{display:"flex",gap:1,minWidth:20}}>{isCasc&&<span style={{fontSize:10}}>âš ï¸</span>}{isEcn&&!ecnDone&&<span style={{fontSize:10}}>ğŸ”´</span>}{ecnDone&&<span style={{fontSize:10}}>âœ…</span>}</div>
              <span style={{flex:1,fontSize:11,opacity:ecnDone?0.5:1}}>{step.name}</span>
              <div style={{display:"flex",gap:2}}>
                {(step.parts?.length||0)>0&&<span style={{fontSize:8,fontWeight:700,padding:"1px 4px",borderRadius:3,background:"rgba(34,197,94,0.06)",color:"#22c55e",fontFamily:mono}}>{step.parts.length}P</span>}
                {(step.fasteners?.length||0)>0&&<span style={{fontSize:8,fontWeight:700,padding:"1px 4px",borderRadius:3,background:"rgba(239,68,68,0.06)",color:"#ef4444",fontFamily:mono}}>{step.fasteners.length}F</span>}
              </div></div>})}
        </div>})}
      </div>
    </>}
    {tab==="graph"&&<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"50vh",color:T.textMuted}}>â—ˆ Graph View â€” Coming soon</div>}
    {tab==="kanban"&&<div style={{display:"flex",alignItems:"center",justifyContent:"center",minHeight:"50vh",color:T.textMuted}}>â–¦ Kanban â€” Coming soon</div>}
  </div>);
}

// TREE EDITOR â€” Full prototype features
function TreeEditorPage({onBack}){
  const{role}=useAuth();const[assemblies,setAssemblies]=useState([]);const[selAsm,setSelAsm]=useState(null);
  const[versions,setVersions]=useState([]);const[activeVer,setActiveVer]=useState(null);
  const[tree,setTree]=useState([]);const[sel,setSel]=useState(null);
  const[loading,setLoading]=useState(true);const[saving,setSaving]=useState(false);
  const[toast,setToast]=useState(null);const[dupModal,setDupModal]=useState(null);const[dupVer,setDupVer]=useState("");const[dupNotes,setDupNotes]=useState("");
  const show=msg=>{setToast(msg);setTimeout(()=>setToast(null),2000)};
  useEffect(()=>{DB.getAssemblies().then(d=>{setAssemblies(d);if(d.length)setSelAsm(d[0]);setLoading(false)})},[]);
  useEffect(()=>{if(!selAsm)return;setLoading(true);DB.getVersions(selAsm.id).then(v=>{setVersions(v);const a=v.find(x=>x.status==='active')||v[0];if(a){setActiveVer(a);DB.getTree(a.id).then(t=>{setTree(t);setLoading(false)})}else setLoading(false)})},[selAsm?.id]);
  const reload=async()=>{if(!activeVer)return;setLoading(true);const t=await DB.getTree(activeVer.id);setTree(t);const v=await DB.getVersions(selAsm.id);setVersions(v);setLoading(false)};
  const switchVer=v=>{setActiveVer(v);setSel(null);setLoading(true);DB.getTree(v.id).then(t=>{setTree(t);setLoading(false)})};
  const locked=activeVer?.status==="frozen";
  const toggleFreeze=async()=>{const ns=locked?"draft":"frozen";if(await DB.updateVersion(activeVer.id,{status:ns})){setActiveVer({...activeVer,status:ns});setVersions(vs=>vs.map(v=>v.id===activeVer.id?{...v,status:ns}:v));show(locked?"âœï¸ Unlocked":"ğŸ”’ Frozen")}};
  const setAsProd=async()=>{for(const v of versions){if(v.id!==activeVer.id&&v.status==='active')await DB.updateVersion(v.id,{status:'frozen'})}await DB.updateVersion(activeVer.id,{status:'active'});setActiveVer({...activeVer,status:'active'});await reload();show("ğŸš€ Production â†’ v"+activeVer.version)};
  const handleDuplicate=async()=>{if(!dupVer)return;setSaving(true);const nv=await DB.cloneVersion(selAsm.id,activeVer.id,dupVer,dupNotes);if(nv){setDupModal(null);setDupVer("");setDupNotes("");const v=await DB.getVersions(selAsm.id);setVersions(v);switchVer(nv);show("ğŸ“‹ Created v"+dupVer)}setSaving(false)};
  const handleAddGroup=async()=>{await DB.addGroup(activeVer.id,tree.length);reload()};
  const handleAddStep=async gId=>{const gs=(tree.find(g=>g.id===gId)?.steps||[]);await DB.addStep(activeVer.id,gId,gs.length);reload()};
  const handleDeleteStep=async sId=>{if(await DB.deleteStep(sId)){setSel(null);reload()}};
  const handleUpdateStep=async(sId,fields)=>{await DB.updateStep(sId,fields);reload()};
  const handleAddPart=async sId=>{await DB.addStepPart(sId,'','',1);reload()};
  const handleRemovePart=async lId=>{await DB.removeStepPart(lId);reload()};
  const handleAddFastener=async sId=>{await DB.addFastener(sId);reload()};
  const handleRemoveFastener=async fId=>{await DB.removeFastener(fId);reload()};
  const handleUpdateFastener=async(fId,fields)=>{await DB.updateFastener(fId,fields)};
  const selStep=sel?(()=>{for(const g of tree){const s=g.steps?.find(x=>x.id===sel);if(s)return{g,s}}return null})():null;
  const getStepName=s=>{if(s.name)return s.name;if(s.parts?.length===1&&s.parts[0].name)return s.parts[0].name;if(s.parts?.length>1)return s.parts.map(p=>p.name||p.pn).filter(Boolean).join(" + ");return""};
  if(role!=="admin")return<div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"60vh",flexDirection:"column",gap:12}}><div style={{fontSize:32}}>ğŸ”’</div><div style={{fontSize:14,color:T.textMuted}}>Admin access required</div><button onClick={onBack} style={btnSm(T.textMuted)}>â† Back</button></div>;
  return(<div style={{display:"flex",height:"calc(100vh - 36px)",background:T.bg,color:T.text,fontFamily:mono,fontSize:11,overflow:"hidden"}}>
    {/* LEFT */}
    <div style={{flex:1,display:"flex",flexDirection:"column",overflow:"hidden"}}>
      <div style={{padding:"8px 12px",borderBottom:"1px solid "+T.border,background:T.headerBg,display:"flex",alignItems:"center",gap:6,flexWrap:"wrap"}}>
        <button onClick={onBack} style={{background:"none",border:"1px solid "+T.border,borderRadius:6,padding:"3px 10px",color:T.textMuted,cursor:"pointer",fontSize:10}}>â† Home</button>
        <span style={{fontSize:14,fontWeight:800,color:"#8b5cf6"}}>ğŸ”§</span>
        {assemblies.length>0&&<select value={selAsm?.id||""} onChange={e=>{setSelAsm(assemblies.find(a=>a.id===e.target.value));setSel(null)}} style={{...inp,fontWeight:600}}>
          {assemblies.map(a=><option key={a.id} value={a.id}>{a.code} â€” {a.name}</option>)}</select>}
        <div style={{width:1,height:16,background:T.border,margin:"0 4px"}}/>
        {versions.map(v=><button key={v.id} onClick={()=>switchVer(v)} style={{padding:"3px 10px",borderRadius:6,fontSize:10,fontWeight:700,cursor:"pointer",border:v.id===activeVer?.id?"2px solid "+(v.status==="frozen"?"#ef4444":v.status==="active"?"#22c55e":"#8b5cf6"):"1px solid "+T.border,background:v.id===activeVer?.id?(v.status==="frozen"?"rgba(239,68,68,0.08)":v.status==="active"?"rgba(34,197,94,0.08)":"rgba(139,92,246,0.08)"):"transparent",color:v.id===activeVer?.id?(v.status==="frozen"?"#ef4444":v.status==="active"?"#22c55e":"#8b5cf6"):T.textMuted,fontFamily:mono}}>
          {v.status==="frozen"?"ğŸ”’":v.status==="active"?"ğŸŸ¢":"âœï¸"} v{v.version}</button>)}
        <button onClick={()=>{setDupModal(true);setDupVer("");setDupNotes("")}} style={btnSm("#8b5cf6")}>ğŸ“‹ Duplicate</button>
        <div style={{marginLeft:"auto",display:"flex",gap:6}}>
          <button onClick={toggleFreeze} style={btnSm(locked?"#22c55e":"#ef4444")}>{locked?"âœï¸ Mark draft":"ğŸ”’ Freeze"}</button>
          {locked&&activeVer?.status!=="active"&&<button onClick={setAsProd} style={btnSm("#22c55e")}>ğŸš€ Set as PROD</button>}
        </div>
      </div>
      {locked&&<div style={{padding:"6px 12px",background:"rgba(239,68,68,0.06)",borderBottom:"1px solid rgba(239,68,68,0.1)",fontSize:10,color:"#ef4444",fontWeight:700,textAlign:"center"}}>ğŸ”’ Tree locked â€” mark draft to edit</div>}
      <div style={{flex:1,overflowY:"auto",padding:"8px 10px"}}>
        {loading?<div style={{textAlign:"center",color:T.textMuted,padding:40}}>Loading...</div>:tree.map(g=>(<div key={g.id} style={{marginBottom:6}}>
          <div style={{display:"flex",alignItems:"center",gap:6,padding:"6px 10px",borderRadius:8,background:(g.color||T.accent)+"08",borderLeft:"3px solid "+(g.color||T.accent)}}>
            <span style={{fontSize:13}}>{g.icon||"ğŸ“¦"}</span>
            <span style={{fontWeight:700,color:g.color||T.accent,flex:1}}>{g.name}</span>
            {g.level!=null&&<span style={{fontSize:8,padding:"1px 5px",borderRadius:4,background:(g.color||T.accent)+"15",color:g.color||T.accent}}>L{g.level}</span>}
            <span style={{color:T.textMuted,fontSize:9}}>{(g.steps||[]).length}</span>
            {!locked&&<button onClick={()=>handleAddStep(g.id)} style={{background:"none",border:"none",color:"#22c55e",cursor:"pointer",fontSize:12,padding:0}}>+</button>}
          </div>
          {(g.steps||[]).map(s=>{const sn=getStepName(s),isSel=sel===s.id;return<div key={s.id} onClick={()=>setSel(s.id)} style={{display:"flex",alignItems:"center",gap:5,padding:"5px 8px 5px 24px",cursor:"pointer",borderRadius:6,margin:"1px 0",background:isSel?"rgba(139,92,246,0.08)":"transparent",border:isSel?"1px solid rgba(139,92,246,0.2)":"1px solid transparent"}}>
            <span style={{fontWeight:700,color:g.color||T.accent,minWidth:24,textAlign:"center",fontSize:10,background:(g.color||T.accent)+"12",padding:"1px 4px",borderRadius:3}}>{s.step_number||"â€”"}</span>
            <span style={{fontSize:9,color:s.step_type==="PREP"?"#a855f7":"#3b82f6",fontWeight:600}}>{s.step_type||"STEP"}</span>
            <span style={{flex:1,color:sn?T.text:T.textDim,fontSize:10,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{sn||"untitled"}</span>
            {(s.parts?.length||0)>0&&<span style={{fontSize:8,color:"#22c55e"}}>{s.parts.length}P</span>}
            {(s.fasteners?.length||0)>0&&<span style={{fontSize:8,color:"#ef4444"}}>{s.fasteners.length}F</span>}
          </div>})}
        </div>))}
        {!locked&&!loading&&<button onClick={handleAddGroup} style={{...btnSm("#6366f1"),width:"100%",marginTop:8,padding:"8px"}}>+ Add Group</button>}
      </div>
    </div>
    {/* RIGHT */}
    <div style={{width:360,borderLeft:"1px solid "+T.border,background:T.bgCard,overflowY:"auto",padding:"12px 14px"}}>
      {selStep?(()=>{const{g,s}=selStep;const lD=locked?0.5:1;return<div>
        <div style={{fontSize:14,fontWeight:700,marginBottom:10}}>{getStepName(s)||"Untitled Step"}</div>
        <div style={{display:"flex",gap:8,alignItems:"center",marginBottom:10}}>
          <div><div style={{fontSize:8,color:T.textMuted}}>TAG</div><input defaultValue={s.step_number||""} key={s.id+"t"} onBlur={e=>handleUpdateStep(s.id,{step_number:e.target.value})} disabled={locked} style={{...inp,width:50,fontWeight:700,opacity:lD}}/></div>
          <div><div style={{fontSize:8,color:T.textMuted}}>TYPE</div><select value={s.step_type||"STEP"} onChange={e=>handleUpdateStep(s.id,{step_type:e.target.value})} disabled={locked} style={{...inp,opacity:lD}}>
            <option value="STEP">STEP</option><option value="PREP">PREP</option><option value="CHECK">CHECK</option></select></div>
          {!locked&&<button onClick={()=>handleDeleteStep(s.id)} style={{...btnSm("#ef4444"),marginLeft:"auto",fontSize:9}}>ğŸ—‘ Delete</button>}
        </div>
        <div style={{padding:"6px 8px",borderRadius:6,marginBottom:10,background:"rgba(139,92,246,0.03)",border:"1px solid "+T.border}}>
          <div style={{fontSize:8,fontWeight:700,color:T.textMuted,marginBottom:3}}>STEP NAME</div>
          {locked?<div style={{fontSize:10,opacity:0.6}}>{s.name||"â€”"}</div>:<input defaultValue={s.name||""} key={s.id+"n"} onBlur={e=>handleUpdateStep(s.id,{name:e.target.value})} placeholder="Name this step..." style={{...inp,width:"100%"}}/>}
        </div>
        <div style={{display:"flex",alignItems:"center",marginBottom:5}}>
          <span style={{fontSize:9,fontWeight:700,color:T.textMuted,textTransform:"uppercase",letterSpacing:0.5,flex:1}}>Parts ({(s.parts||[]).length})</span>
          {!locked&&<button onClick={()=>handleAddPart(s.id)} style={btnSm("#22c55e")}>+ Part</button>}
        </div>
        {(s.parts||[]).map(p=><div key={p.id} style={{display:"flex",gap:3,alignItems:"center",marginBottom:3,padding:"4px 6px",borderRadius:5,border:"1px solid "+T.border}}>
          <span style={{fontSize:10,fontWeight:700,color:"#0ea5e9",fontFamily:mono,minWidth:70}}>{p.pn||"â€”"}</span>
          <span style={{flex:1,fontSize:9}}>{p.name||"unnamed"}</span>
          <span style={{fontSize:9,color:T.textMuted}}>Ã—{p.qty}</span>
          {!locked&&<button onClick={()=>handleRemovePart(p.id)} style={{background:"none",border:"none",color:"#ef4444",fontSize:9,cursor:"pointer"}}>âœ•</button>}
        </div>)}
        {(s.parts||[]).length===0&&<div style={{fontSize:9,color:T.textDim,marginBottom:6,fontStyle:"italic"}}>No parts assigned</div>}
        <div style={{display:"flex",alignItems:"center",marginTop:8,marginBottom:5}}>
          <span style={{fontSize:9,fontWeight:700,color:T.textMuted,textTransform:"uppercase",letterSpacing:0.5,flex:1}}>Fasteners ({(s.fasteners||[]).length})</span>
          {!locked&&<button onClick={()=>handleAddFastener(s.id)} style={btnSm("#f59e0b")}>+ Fastener</button>}
        </div>
        {(s.fasteners||[]).map(f=><div key={f.id} style={{display:"flex",gap:3,alignItems:"center",marginBottom:2,padding:"3px 5px",borderRadius:4,border:"1px solid "+T.border}}>
          <span style={{fontSize:10,fontWeight:700,color:"#f59e0b",fontFamily:mono,minWidth:60}}>{f.code||"â€”"}</span>
          <span style={{fontSize:9,color:T.textMuted}}>{f.torque}</span>
          <span style={{fontSize:9,color:T.textMuted}}>{f.loctite}</span>
          <span style={{fontSize:9,color:T.textMuted,marginLeft:"auto"}}>Ã—{f.qty}</span>
          {!locked&&<button onClick={()=>handleRemoveFastener(f.id)} style={{background:"none",border:"none",color:"#ef4444",fontSize:9,cursor:"pointer"}}>âœ•</button>}
        </div>)}
      </div>})():(<div style={{display:"flex",flexDirection:"column",alignItems:"center",justifyContent:"center",height:"100%",color:T.textDim,fontSize:12}}>
        <div style={{fontSize:28,marginBottom:10,opacity:0.3}}>ğŸ”§</div><div>Select a step to edit</div></div>)}
    </div>
    {toast&&<div style={{position:"fixed",bottom:20,left:"50%",transform:"translateX(-50%)",padding:"8px 20px",borderRadius:8,background:"#22c55e",color:"#000",fontWeight:700,fontSize:11,zIndex:999,fontFamily:mono}}>{toast}</div>}
    {dupModal&&<div onClick={()=>setDupModal(null)} style={{position:"fixed",inset:0,zIndex:100,background:"rgba(0,0,0,0.6)",display:"flex",alignItems:"center",justifyContent:"center"}}>
      <div onClick={e=>e.stopPropagation()} style={{background:T.bgModal,borderRadius:12,width:360,padding:20,border:"1px solid "+T.border}}>
        <div style={{fontSize:14,fontWeight:700,marginBottom:6}}>ğŸ“‹ Duplicate v{activeVer?.version}</div>
        <div style={{fontSize:10,color:T.textMuted,marginBottom:12,lineHeight:1.6}}>This will: â‘  Clone the current tree â‘¡ Set new version as current â‘¢ Mark ALL units as outdated</div>
        <div style={{fontSize:9,color:T.textMuted,marginBottom:3}}>New Version*</div>
        <input value={dupVer} onChange={e=>setDupVer(e.target.value)} placeholder="e.g. 6.1" style={{...inp,width:"100%",marginBottom:8,fontSize:14,padding:"8px 10px"}} autoFocus/>
        <div style={{fontSize:9,color:T.textMuted,marginBottom:3}}>Notes (optional)</div>
        <input value={dupNotes} onChange={e=>setDupNotes(e.target.value)} placeholder="What changed..." style={{...inp,width:"100%",marginBottom:12}}/>
        <div style={{display:"flex",gap:8,justifyContent:"flex-end"}}>
          <button onClick={()=>setDupModal(null)} style={{...btnSm(T.textMuted)}}>Cancel</button>
          <button onClick={handleDuplicate} disabled={!dupVer||saving} style={{padding:"6px 16px",borderRadius:6,fontSize:11,fontWeight:700,background:saving?"#666":"#8b5cf6",border:"none",color:"#fff",cursor:dupVer&&!saving?"pointer":"not-allowed",opacity:dupVer?1:0.4}}>{saving?"Cloning...":"Create v"+(dupVer||"?")}</button>
        </div>
      </div>
    </div>}
  </div>);
}

// MAIN APP
function App(){
  const{session,loading}=useAuth();const[page,setPage]=useState("home");const[assembly,setAssembly]=useState(null);const[units,setUnits]=useState([]);
  if(loading)return<div style={{display:"flex",alignItems:"center",justifyContent:"center",height:"100vh",color:T.textMuted,flexDirection:"column",gap:12}}><div style={{width:24,height:24,border:"2px solid "+T.accent,borderTopColor:"transparent",borderRadius:"50%",animation:"spin 0.6s linear infinite"}}/><span style={{fontSize:12}}>Loading...</span></div>;
  if(!session)return<LoginScreen/>;
  return(<div style={{minHeight:"100vh",background:T.bg,color:T.text}}>
    <TopBar onHome={()=>{setPage("home");setAssembly(null);setUnits([])}}/>
    {page==="home"&&<HomePage onNav={(p,a)=>{if(p==="units"&&a){setAssembly(a);setPage("unitSelect")}else if(p==="units")setPage("unitSelect");else setPage(p)}}/>}
    {page==="unitSelect"&&assembly&&<UnitSelectPage assembly={assembly} onBack={()=>setPage("home")} onProceed={u=>{setUnits(u);setPage("assembly")}}/>}
    {page==="assembly"&&assembly&&<AssemblyViewPage assembly={assembly} selectedUnits={units} onBack={()=>setPage("unitSelect")}/>}
    {page==="editor"&&<TreeEditorPage onBack={()=>setPage("home")}/>}
  </div>);
}
const root=ReactDOM.createRoot(document.getElementById('root'));
root.render(<AuthProvider><App/></AuthProvider>);
</script></body></html>
